import { EmptyState, Layout } from "@/components";
import { Calendar } from "@/events";
import { t } from "@/locales";
import { appName, api } from "@/utils";
import { type NextPage } from "next";
import Head from "next/head";
import { useState } from "react";
import {
  endOfMonth,
  isSameDay,
  isToday,
  startOfMonth,
  startOfToday,
} from "date-fns";

const Home: NextPage = () => {
  const today = startOfToday();
  const [selectedDay, setSelectedDay] = useState<Date>(today);
  const [selectedMonth, setSelectedMonth] = useState(startOfMonth(today));

  const { data, isLoading, isFetching, error } =
    api.event.getAllBetween.useQuery({
      startDate: startOfMonth(selectedMonth),
      endDate: endOfMonth(selectedMonth),
    });

  const eventsOfSelectedDay = data?.filter((event) =>
    isSameDay(selectedDay, event.date)
  );

  const handleChange = (day: Date) => {
    console.log(day);
    setSelectedDay(day);
  };

  const hasEventOnDate = (date: Date) => {
    const event = data?.find((event) => isSameDay(date, event.date));
    return event ? true : false;
  };

  return (
    <Layout>
      <Head>
        <title>{`${appName} - ${t.common.homePage}`}</title>
        <meta name="description" content="Generated by create-t3-app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>
      <main className="flex h-full flex-col p-4">
        <h1>Home</h1>
        <Calendar month={selectedMonth}>
          {(day) => (
            <div
              onClick={() => handleChange(day)}
              className={`${isToday(day) ? " bg-secondary bg-opacity-50" : ""}${
                isSameDay(day, selectedDay) ? " border border-black" : ""
              }${
                hasEventOnDate(day) ? "" : " text-gray-400"
              } flex h-8 w-8 items-center justify-center rounded-full text-center`}
            >
              {day.getDate()}
            </div>
          )}
        </Calendar>
        {eventsOfSelectedDay?.length > 0 ? (
          eventsOfSelectedDay?.map((event) => (
            <div key={event.id}>
              <span>{event.name}</span>
              <span>{event.date.toString()}</span>
            </div>
          ))
        ) : (
          <EmptyState className="flex-grow" text={t.signIn.emptyText} />
        )}
      </main>
    </Layout>
  );
};

export default Home;
